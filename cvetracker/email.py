#!/usr/bin/python

import smtplib

from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText

from cvetracker.config import CONFIG


class EmailHelper(object):
    def __init__(self):
        conf = CONFIG.config
        self.host = conf.get('smtp', 'host')
        self.port = conf.get('smtp', 'port')
        self.username = conf.get('smtp', 'username', fallback=None)
        self.password = conf.get('smtp', 'password', fallback=None)
        self.smtp_ssl = conf.getboolean('smtp', 'smtp-ssl', fallback=False)

    def send_message(self, from_addr, to_addr, message):
        if self.smtp_ssl:
            SMTP = smtplib.SMTP_SSL
        else:
            SMTP = smtplib.SMTP

        with SMTP(self.host, self.port) as server:
            server.ehlo()
            if self.username:
                if not self.smtp_ssl:
                    server.starttls()
                    server.ehlo()
                server.login(self.username, self.password)

            if message.get('From') is None:
                message['From'] = to_addr

            if message.get('To') is None:
                message['To'] = to_addr

            server.send_message(message, from_addr, to_addr)
            server.quit()

    def message(self, subject, message, message_type='plain',
                     from_name=None, to_name=None):
        msg = MIMEMultipart()
        if from_name:
            msg['From'] = from_name
        if to_name:
            msg['To'] = to_name
        if subject:
            msg['Subject'] = subject
        if message:
            part = MIMEText(message, message_type)
            msg.attach(part)
        return msg
