
import logging

from lib.db.models import *
from lib.db.api import DBAPI


DISTRIBUTION_ALIASES = {
    ('trusty', ): {
        'name': 'Ubuntu',
        'version': '14.04',
    },
    ('xenial', ): {
        'name': 'Ubuntu',
        'version': '16.04',
    },
    ('el6', ): {
        'name': 'RedHat',
        'version': '6',
    },
    ('el7', ): {
        'name': 'RedHat',
        'version': '7',
    }
}


class NoRecordsFound(Exception):
    pass


class MultipleRecordsFound(Exception):
    pass


class GenericAdapter(object):
    def __init__(self, instance=None):
        self.db_api = DBAPI()
        if instance:
            self._ = instance
            self.db_api.session.add(self._)
            self.db_api.session.flush()
        else:
            self._ = None

    def try_load(self, *args, **kwargs):
        for filter in self._filters:
            passed = True
            _kwargs = {}
            for key in filter:
                if key in kwargs:
                    _kwargs[key] = kwargs[key]
                else:
                    passed = False
                    break
            if passed:
                self.load(**_kwargs)
                return

        raise Exception("No filter pair matched in try_load(). "
                        "Available pairs '{}'".format(self._filters))

    def load(self, **kwargs):
        query = self.db_api.session.query(self._class)
        for name, value in kwargs.items():
            query = query.filter(getattr(self._class, name) == value)
        res = query.all()
        if len(res) == 0:
            raise NoRecordsFound("No records found for '{}'"
                                 .format(kwargs))
        if len(res) > 1:
            raise MultipleRecordsFound("More than one records found for '{}'"
                                       .format(kwargs))
        self._ = query.one()

    def initialize(self, *args, **kwargs):
        try:
            self.load(**kwargs)
            return
        except NoRecordsFound:
            self._ = self.db_api.get(self._class, **kwargs)
        except:
            raise

    def search(self, *args, **kwargs):
        query = self.db_api.session.query(self._class)
        for name, value in kwargs.items():
            query = query.filter(getattr(self._class, name) == value)
        return query.all()

    def add_property(self, name, value, unique=False):
        cls_name = self._.__class__.__name__
        property_cls = eval(cls_name + 'Property')

        if unique:
            prop = self.db_api.get(property_cls, parent_id=self._.id,
                                   name=name)
            if isinstance(prop, list):
                raise Exception("Multiple properties found but not allowed.")
            prop.value = value
        else:
            prop = self.db_api.get(property_cls, parent_id=self._.id,
                                   name=name, value=value)

        if prop not in self._.properties:
            self._.properties.append(prop)

    def get(self, name):
        return getattr(self._, name)

    def set(self, name, value):
        setattr(self._, name, value)

    def commit(self):
        self.db_api.session.commit()

    @property
    def id(self):
        return self._.id

    @property
    def properties(self):
        hidden_properties = getattr(self, '_hidden_properties', ())
        for x in self._.properties:
            if x.name in hidden_properties:
                continue
            yield x


class ProjectAdapter(GenericAdapter):
    log = logging.getLogger(__name__)

    def __init__(self, *args, **kwargs):
        self._class = SourceProject
        self._filters = (
            ('id',),
            ('name', ),
        )
        super().__init__(*args, **kwargs)


class SourcePackageAdapter(GenericAdapter):
    log = logging.getLogger(__name__)

    def __init__(self, *args, **kwargs):
        self._class = SourcePackage
        self._filters = (
            ('id',),
            ('name', 'version'),
        )
        super().__init__(*args, **kwargs)

    @property
    def cves(self):
        for x in self._.cves:
            yield CVEAdapter(x.cve)

    @property
    def advisories(self):
        for x in self._.advisories:
            yield AdvisoryAdapter(x.advisory)

    @property
    def distributions(self):
        for x in self._.distributions:
            yield DistributionAdapter(x.distribution), x.version

    @property
    def name(self):
        return self._.project.name

    @property
    def version(self):
        return self._.version


class DistributionPackageAdapter(GenericAdapter):
    log = logging.getLogger(__name__)

    def __init__(self, *args, **kwargs):
        self._class = SourcePackageDistribution
        self._filters = (
            ('id',),
            ('source_package', 'distribution', 'version'),
        )
        super().__init__(*args, **kwargs)

    @property
    def name(self):
        return self._.source_package.project.name

    @property
    def upstream_version(self):
        return self._.source_package.version

    @property
    def version(self):
        return self._.version

    @property
    def source_package(self):
        return self._.source_package


class CVEAdapter(GenericAdapter):
    log = logging.getLogger(__name__)

    def __init__(self, *args, **kwargs):
        self._class = CVE
        self._hidden_properties = ('advisory', )
        self._filters = (
            ('id',),
            ('name',),
        )
        super().__init__(*args, **kwargs)

    @property
    def advisories(self):
        # for x in self._.advisories:
        #     yield AdvisoryAdapter(x.advisory)
        for x in self._.properties:
            if x.name == 'advisory':
                obj = AdvisoryAdapter()
                obj.initialize(id=x.value)
                yield obj

    @property
    def source_packages(self):
        for x in self._.source_packages:
            yield SourcePackageAdapter(x.source_package)

    @property
    def urls(self):
        for x in self.properties:
            if x.name.lower() == 'url':
                yield x.value

    @property
    def name(self):
        return self._.name

    @property
    def subject(self):
        return self._.subject


class DistributionAdapter(GenericAdapter):
    log = logging.getLogger(__name__)

    def __init__(self, *args, **kwargs):
        self._class = Distribution
        self._filters = (
            ('id',),
            ('name', 'version', 'arch',),
        )
        super().__init__(*args, **kwargs)

    @property
    def source_packages(self):
        for x in self._.packages:
            yield SourcePackageAdapter(x.source_package), x.version

    def add_package(self, source_package, version):
        return self.db_api.get(
            SourcePackageDistribution,
            source_package=source_package._,
            distribution=self._,
            version=version
        )

    def initialize(self, *args, **kwargs):
        if 'alias' in kwargs:
            alias = kwargs.pop('alias')
            for aliases, data in DISTRIBUTION_ALIASES.items():
                if alias in aliases:
                    alias = None
                    kwargs.update(data)
                    break
            if alias:
                raise Exception("Distribution alias '{}' not known"
                                .format(alias))
        super().initialize(*args, **kwargs)

    @property
    def name(self):
        return self._.name

    @property
    def version(self):
        return self._.version

    @property
    def arch(self):
        return self._.arch


class AdvisoryAdapter(GenericAdapter):
    log = logging.getLogger(__name__)

    def __init__(self, *args, **kwargs):
        self._class = Advisory
        self._hidden_properties = ('cve', 'distribution',
                                   'distribution_package', )
        self._filters = (
            ('id',),
            ('name',),
        )
        super().__init__(*args, **kwargs)

    @property
    def cves(self):
        # for x in self._.cves:
        #     yield CVEAdapter(x.cve)
        for x in self._.properties:
            if x.name == 'cve':
                obj = CVEAdapter()
                obj.initialize(id=x.value)
                yield obj

    @property
    def source_packages(self):
        for x in self._.source_packages:
            yield SourcePackageAdapter(x.source_package)

    @property
    def distribution_packages(self):
        for x in self._.properties:
            if x.name == 'distribution_package':
                obj = DistributionPackageAdapter()
                obj.initialize(id=x.value)
                yield obj

    @property
    def distributions(self):
        for x in self._.properties:
            if x.name == 'distribution':
                obj = DistributionAdapter()
                obj.initialize(id=x.value)
                yield obj

    def add_cve(self, name):
        cve = CVEAdapter()
        cve.initialize(name=name)
        self.db_api.get(AdvisoryCVE,
                        advisory=self._,
                        cve=cve._)
        return cve

    def add_source_package(self, name, version):
        prj = ProjectAdapter()
        prj.initialize(name=name)

        pkg = SourcePackageAdapter()
        pkg.initialize(project=prj._, version=version)

        # self.db_api.get(AdvisorySourcePackage,
        #                 advisory=self._,
        #                 source_package=pkg._)
        return pkg

    def commit(self):
        for cve in self.cves:
            cve.add_property(name='advisory',
                             value=self._.id)

        for pkg in self.distribution_packages:
            pkg.add_property(name='advisory',
                             value=self._.id)

        # # Link CVE and SourcePackage
        # for pkg_link in self._.source_packages:
        #     for cve_link in self._.cves:
        #         self.db_api.get(
        #             SourcePackageCVE,
        #             source_package=pkg_link.source_package,
        #             cve=cve_link.cve
        #         )
        super().commit()

    @property
    def name(self):
        return self._.name

    @property
    def subject(self):
        return self._.subject

    @property
    def url(self):
        return self._.url
