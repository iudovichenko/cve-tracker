
import logging
import re

from lib.db.models import *
from lib.db.api import DBAPI
from lib.misc import DebianVersion


class GenericAdapter(object):
    _catalog = {}
    db_api = DBAPI()
    log = logging.getLogger(__name__)

    def __new__(cls, instance=None, *args, **kwargs):
        if instance:
            return cls._catalog.setdefault(instance, super().__new__(cls))
        return cls.load(*args, **kwargs)
        # return super().__new__(cls)

    def __init__(self, instance=None, *args, **kwargs):
        if instance:
            if self.__dict__.get('_', None) is None:
                self.log.debug("Adding instance {} to session {}".format(
                    instance, self.db_api.session
                ))
                self._ = instance
                self.db_api.session.add(self._)
                self.db_api.session.flush()
        else:
            self._ = None

    def __getattr__(self, item):
        return self.__dict__.get(item, getattr(self._, item))

    @classmethod
    def load(cls, **kwargs):
        model = eval(re.sub(r'Adapter$', '', cls.__name__))
        query = cls.db_api.session.query(model)
        cls.log.debug(kwargs)
        instance = query.filter_by(**kwargs).one()
        return cls(instance)

    @classmethod
    def init(cls, **kwargs):
        model = eval(re.sub(r'Adapter$', '', cls.__name__))
        query = cls.db_api.session.query(model)
        cls.log.debug(kwargs)
        instance = query.filter_by(**kwargs).one_or_none()
        if instance is None:
            instance = model(**kwargs)
        return cls(instance)

    def get(self, name, default=None):
        return getattr(self, name, getattr(self._, name, default))

    def set(self, name, value):
        setattr(self._, name, value)

    def search(self, *args, **kwargs):
        model = eval(re.sub(r'Adapter$', '', self.__class__.__name__))
        query = self.db_api.session.query(model)
        for name, value in kwargs.items():
            query = query.filter(getattr(model, name) == value)
        return query.all()

    def get_property(self, name, scalar=False):
        cls = eval(self._.__class__.__name__ + 'Property')
        property = self.db_api.get(cls,
                                   parent_id=self._.id,
                                   name=name)
        if scalar:
            if isinstance(property, list):
                raise Exception("Multiple properties found but not allowed.")
        return property

    def set_property(self, name, value):
        property = self.get_property(name, scalar=True)
        property.value = value
        self._.properties.add(property)

    def add_property(self, name, value):
        cls = eval(self._.__class__.__name__ + 'Property')

        property = self.db_api.get(cls,
                                   parent_id=self._.id,
                                   name=name,
                                   value=value)

        self._.properties.add(property)

    def properties(self, name=None):
        for x in self._.properties:
            if name is None:
                yield x.name, x.value
            elif x.name.lower() == str(name).lower():
                yield x.name, x.value

    def commit(self):
        self.db_api.session.commit()

    def __repr__(self):
        return 'Class: {}, ID: {}'.format(self.__class__.__name__, self._.id)

    def export(self):
        data = {
            'property': {},
        }

        for name, value in self.properties():
            data['property'].setdefault(name, []).append(value)

        return data

    def dict(self, **kwargs):
        data = kwargs.get('data', {})
        append = kwargs.get('append', {})
        p = {}

        try:
            for item in self.properties:
                p.setdefault(item.name, []).append(item.value)
        except:
            pass

        for k, v in p.items():
            if len(v) == 1:
                p[k] = v[0]

        data.update({
            '__class__': self.__class__.__name__,
            '__str__': str(self),
            'id': self.id,
        })
        data.update(append)
        data.update({
            'property': p
        })
        return data

    def show(self, **kwargs):
        cols = []
        data = []
        raw = self.export()

        if kwargs.get('formatter', None) == 'TableFormatter':
            for path, name in kwargs.get('fields', ()):
                value = raw
                try:
                    for key in path:
                        value = value.get(key, None)
                except:
                    value = None
                cols.append(name)
                data.append(value)

            for key, value in raw.get('property', {}).items():
                if isinstance(value, list):
                    for x in value:
                        cols.append('Property:{}'.format(key))
                        data.append(x)
                else:
                    cols.append('Property:{}'.format(key))
                    data.append(value)
        else:
            for k, v in raw.items():
                cols.append(k)
                data.append(v)

        return cols, data, raw


class AdvisoryAdapter(GenericAdapter):
    @property
    def cves(self):
        for x in self._.cves:
            yield CVEAdapter(x)

    @property
    def source_packages(self):
        for x in self._.source_packages:
            yield SourcePackageAdapter(x)

    @property
    def distribution_packages(self):
        for x in self._.distribution_packages:
            yield DistributionPackageAdapter(x)

    def add_cve(self, cve):
        self._.cves.add(cve._)

    def add_source_package(self, name, version):
        prj = SourceProjectAdapter.init(name=name)
        pkg = SourcePackageAdapter.init(project=prj._, version=version)
        self._.source_packages.add(pkg._)
        return pkg

    def add_package(self, package):
        self._.distribution_packages.add(package._)

    def commit(self):
        super().commit()

    def update(self, data={}):
        url = data.get('url', None)
        if url:
            self.set('url', url)

        subject = data.get('subject', None)
        if subject:
            self.set('subject', subject)

        ts = data.get('timestamp', None)
        if ts:
            self.set_property(name='released_on', value=str(ts))

        for cve_name, cve_data in data.get('cves', {}).items():
            cve = CVEAdapter.init(name=cve_name)

            cve.set('subject', cve_data.get('subject', ''))
            url = cve_data.get('url', None)
            if url:
                cve.add_property(
                    name='URL',
                    value=url
                )

            for url in cve_data.get('references', []):
                cve.add_property(name='reference', value=url)

            self._.cves.add(cve._)

        for pkg_data in data.get('packages', []):
            prj = SourceProjectAdapter.init(name=pkg_data['name'])

            pkg = SourcePackageAdapter.init(
                project=prj._,
                version=pkg_data['upstream_version']
            )

            self._.source_packages.add(pkg._)

            dist = DistributionAdapter.load_by_alias(alias=pkg_data['dist'])

            dist_pkg = DistributionPackageAdapter.init(
                source_package=pkg._,
                distribution=dist._,
                version=pkg_data['full_version']
            )

            self._.distribution_packages.add(dist_pkg._)

        for cve in self._.cves:
            for pkg in self._.source_packages:
                obj = SourcePackageIssueAdapter.init(
                    package=pkg, issue=cve)
                if obj._.status is None:
                    obj.set('status', 'Affected')

            for pkg in self._.distribution_packages:
                obj = DistributionPackageIssueAdapter.init(
                    package=pkg, issue=cve)
                if obj._.status is None:
                    obj.set('status', 'UNKNOWN')

        #self.commit()

    def show(self, formatter=None):
        fields = (
            (('id',), 'ID'),
            (('name',), 'Name'),
            (('subject',), 'Subject'),
            (('url',), 'URL'),
        )
        cols, data, raw = super().show(fields=fields, formatter=formatter)

        if formatter == 'TableFormatter':
            fmt = '{0[project][name]}'
            for x in raw.get('source_packages', []):
                cols.append('Package')
                data.append(fmt.format(x))

            fmt = '{0[source_package][project][name]}-' \
                  '{0[source_package][version]} ' \
                  '({0[distribution][name]} ' \
                  '{0[distribution][version]} ' \
                  '{0[distribution][arch]})'
            for x in raw.get('distribution_packages', []):
                cols.append('Distribution package')
                data.append(fmt.format(x))

            fmt = '{0[name]}'
            for x in raw.get('cves', []):
                cols.append('CVE')
                data.append(fmt.format(x))

        return cols, data, raw

    def export(self):
        data = super().export()

        data['source_packages'] = [
            x.dict() for x in self.source_packages
        ]

        data['distribution_packages'] = [
            x.dict() for x in self.distribution_packages
        ]

        data['cves'] = [
            x.dict() for x in self.cves
        ]

        return data

    def dict(self, append={}):
        data = {
            'name': self.name,
            'subject': self.subject,
            'url': self.url,
        }
        super().dict(data=data, append=append)
        return data


class CVEAdapter(GenericAdapter):
    @property
    def advisories(self):
        for x in self._.advisories:
            yield AdvisoryAdapter(x)

    @property
    def source_package_issues(self):
        for x in self._.source_packages:
            yield SourcePackageIssueAdapter(x)

    @property
    def source_packages(self):
        for x in self.source_package_issues:
            yield x.package

    @property
    def urls(self):
        for x in self.properties:
            if x.name.lower() == 'url':
                yield x.value

    @property
    def distribution_package_issues(self):
        for x in self._.distribution_packages:
            yield DistributionPackageIssueAdapter(x)

    @property
    def product_package_issues(self):
        for x in self._.product_packages:
            yield ProductPackageIssueAdapter(x)

    def show(self, formatter=None):
        fields = (
            (('id',), 'ID'),
            (('name',), 'Name'),
            (('subject',), 'Subject'),
        )
        cols, data, raw = super().show(fields=fields, formatter=formatter)

        if formatter == 'TableFormatter':
            for x in raw.get('advisories', []):
                cols.append('Advisory')
                data.append(x['name'])

            for x in raw.get('source_package_issues', []):
                cols.append('Affects')
                data.append(x['__str__'])

            for x in raw.get('distribution_package_issues'):
                cols.append('Affected Distribution')
                data.append(x['__str__'])

            for x in raw.get('product_package_issues'):
                cols.append('Affected Product')
                data.append(x['__str__'])

        return cols, data, raw

    def export(self):
        data = super().export()

        data['advisories'] = [
            x.dict() for x in self.advisories
        ]

        data['source_package_issues'] = [
            x.dict() for x in self.source_package_issues
        ]

        data['distribution_package_issues'] = [
            x.dict() for x in self.distribution_package_issues
        ]

        data['product_package_issues'] = [
            x.dict() for x in self.product_package_issues
        ]

        return data

    def update_status(self):
        for sp in self.source_packages:
            for dp in sp.distribution_packages:
                issues = list(dp.issues(self))
                if len(issues) == 0:
                    dp.add_cve(self)
                for pp in dp.product_packages:
                    issues = list(pp.issues(self))
                    if len(issues) == 0:
                        pp.add_cve(self)
        self.commit()

    def dict(self, append={}):
        data = {
            'name': self.name,
            'subject': self.subject,
        }
        super().dict(data=data, append=append)
        return data


class DistributionAdapter(GenericAdapter):
    @property
    def source_packages(self):
        for x in self._.packages:
            yield SourcePackageAdapter(x.source_package), x.version

    @property
    def distribution_packages(self):
        for x in self._.packages:
            yield DistributionPackageAdapter(x)

    def add_package(self, source_package, version=None):
        obj = DistributionPackageAdapter.init(
            source_package=source_package._,
            distribution=self._,
            version=version,
        )
        return obj

    def initialize(self, *args, **kwargs):
        if 'alias' in kwargs:
            alias = kwargs.pop('alias').split('-')[0]
            for aliases, data in DISTRIBUTION_ALIASES.items():
                if alias in aliases:
                    alias = None
                    kwargs.update(data)
                    break
            if alias:
                self.log.warning("Distribution alias '{}' not known, "
                                 "using '_NONE_' distribution instead"
                                 .format(alias))
                self.none()
                return
        super().initialize(*args, **kwargs)

    @classmethod
    def load_by_alias(cls, alias):
        aliases = list(cls.db_api.query(DistributionProperty,
                                        name='alias',
                                        value=alias))
        if len(aliases) == 0:
            cls.log.error("No distribution found with alias '{}'"
                          .format(alias))
            return DistributionAdapter.none()

        if len(aliases) > 1:
            raise Exception("Multiple distributions found with alias {}"
                            .format(alias))

        return DistributionAdapter(aliases[0].parent)

    @classmethod
    def none(cls):
        return cls.init(name=None, version=None, arch=None)

    @property
    def is_none(self):
        return self.name is None

    def __str__(self):
        if self.name is None:
            return '_NONE_'
        else:
            s = '{}'.format(self.name)
            if self.version:
                s += ' {}'.format(self.version)
            if self.arch:
                s += ' ({})'.format(self.arch)
            return s

    def show(self, formatter=None):
        fields = (
            (('id',), 'ID'),
            (('name',), 'Name'),
            (('version',), 'Version'),
            (('arch',), 'Architecture'),
        )
        cols, data, raw = super().show(fields=fields, formatter=formatter)

        if formatter == 'TableFormatter':
            for x in raw.get('distribution_packages'):
                cols.append('Distribution package')
                data.append(x['__str__'])

        return cols, data, raw

    def export(self):
        data = super().export()

        data['distribution_packages'] = [
            x.dict() for x in self.distribution_packages
        ]

        return data

    def dict(self, append={}):
        data = {
            'name': self.name,
            'version': self.version,
            'arch': self.arch,
        }
        super().dict(data=data, append=append)
        return data


class DistributionPackageAdapter(GenericAdapter):
    @property
    def advisories(self):
        for x in self._.advisories:
            yield AdvisoryAdapter(x)

    @property
    def name(self):
        return self._.source_package.project.name

    @property
    def version(self):
        return self._.version or '<empty>'

    @property
    def distribution(self):
        return DistributionAdapter(self._.distribution)

    @property
    def products(self):
        for x in self._.products:
            yield ProductAdapter(x.product)

    @property
    def product_packages(self):
        for x in self._.product_packages:
            yield ProductPackageAdapter(x)

    @property
    def source_package(self):
        return SourcePackageAdapter(self._.source_package)

    @property
    def packages(self):
        sp = self.source_package
        for pp in self.product_packages:
            yield sp, self, pp
        else:
            if pp is None:
                yield sp, self, pp

    @property
    def cves(self):
        for x in self._.issues:
            yield DistributionPackageIssueAdapter(x)

    def issues(self, cve):
        for x in self.db_api.query(DistributionPackageIssue,
                                   DistributionPackageIssueAdapter,
                                   package=self._,
                                   issue=cve._):
            yield x

    def add_cve(self, cve, affected=True, resolved=False):
        obj = DistributionPackageIssueAdapter.init(
            package=self._, issue=cve._
        )
        obj.set('affected', affected)
        obj.set('resolved', resolved)
        return obj

    def __str__(self):
        fields = []
        fields.append('{: <36}'.format(self.id))
        fields.append('{: <40}'.format(
            '{}-{}'.format(self.name, self.version)))
        fields.append('{: <25}'.format(str(self.distribution)))
        return ' | '.join(fields)

    def show(self, formatter):
        fields = (
            (('id',), 'ID'),
            (('source_package', 'project', 'name',), 'Name'),
            (('version',), 'Version'),
            (('source_package', '__str__'), 'Source Package'),
        )
        cols, data, raw = super().show(fields=fields, formatter=formatter)

        if formatter == 'TableFormatter':
            for x in raw.get('advisories', []):
                cols.append('Advisory')
                data.append(x)

            for x in raw.get('cves', []):
                cols.append('CVE')
                data.append(x['__str__'])

            for x in raw.get('product_packages', []):
                cols.append('Product Package')
                data.append(x['__str__'])

        return cols, data, raw

    def export(self):
        data = super().export()

        data['advisories'] = [x.dict() for x in self.advisories]
        data['cves'] = [x.dict() for x in self.cves]
        data['product_packages'] = [x.dict() for x in self.product_packages]

        return data

    def dict(self, append={}):
        data = {
            'distribution': self.distribution.dict(),
            'source_package': self.source_package.dict(),
            'version': self.version,
        }
        super().dict(data=data, append=append)
        return data

    def update(self, **kwargs):
        if 'distribution' in kwargs:
            dist = DistributionAdapter(id=kwargs['distribution'])
            self._.distribution = dist._

        if 'version' in kwargs:
            self.set('version', kwargs['version'])

        self.commit()


class DistributionPackageIssueAdapter(GenericAdapter):
    @property
    def package(self):
        return DistributionPackageAdapter(self._.package)

    @property
    def distribution(self):
        return DistributionAdapter(self._.package.distribution)

    @property
    def status(self):
        return self._.status or '<empty>'

    @status.setter
    def status(self, value):
        self._.status = value

    def __str__(self):
        fields = []
        fields.append('{: <15}'.format(str(self._.issue.name)))
        fields.append('{: <20}'.format(str(self.package)))
        fields.append('{}'.format('A' if self.affected else 'N/A'))
        fields.append('{}'.format('R' if self.resolved else 'N/R'))
        return ' | '.join(fields)

    def dict(self, append={}):
        issue = CVEAdapter(self._.issue)
        data = {
            'issue': issue.dict(),
            'package': self.package.dict(),
            'affected': self.affected,
            'resolved': self.resolved,
            'status': self.status,
        }
        super().dict(data=data, append=append)
        return data


class ProductAdapter(GenericAdapter):
    @property
    def packages(self):
        for x in self._.packages:
            yield ProductPackageAdapter(x)

    @property
    def product_packages(self):
        for x in self._.packages:
            yield ProductPackageAdapter(x)

    def show(self, formatter=None):
        fields = (
            (('id',), 'ID'),
            (('name',), 'Name'),
            (('version',), 'Version'),
        )
        cols, data, raw = super().show(fields=fields, formatter=formatter)

        if formatter == 'TableFormatter':
            for key, value in raw.get('packages', {}).items():
                cols.append('Distrirution')
                data.append('{}, {} packages'
                            .format(key, len(value)))

        return cols, data, raw

    def export(self):
        data = super().export()

        data['packages'] = {}

        for x in self.packages:
            data['packages'].setdefault(str(x.distribution), [])\
                .append(x.dict())

        return data

    def dict(self, append={}):
        data = {
            'name': self.name,
            'version': self.version,
            'vendor': self.vendor,
        }
        super().dict(data=data, append=append)
        return data

    def __str__(self):
        return '{} {}'.format(self.name, self.version)


class ProductBinaryPackageAdapter(GenericAdapter):
    @property
    def product_package(self):
        return ProductPackageAdapter(self._.product_package)

    def dict(self, append={}):
        data = {
            'name': self._.name,
            'product_package': self.product_package.dict(),
        }
        super().dict(data=data, append=append)
        return data


class ProductPackageAdapter(GenericAdapter):
    @property
    def name(self):
        return self._.distribution_package.source_package.project.name

    @property
    def version(self):
        return self._.version

    @version.setter
    def version(self, value):
        self._.version = value

    @property
    def distribution_version(self):
        return self._.distribution_package.version

    @property
    def distribution_package(self):
        return DistributionPackageAdapter(self._.distribution_package)

    @distribution_package.setter
    def distribution_package(self, value):
        self._.distribution_package = value._

    @property
    def upstream_version(self):
        return self._.distribution_package.source_package.version

    @property
    def distribution(self):
        return DistributionAdapter(self._.distribution_package.distribution)

    @property
    def product(self):
        return ProductAdapter(self._.product)

    @product.setter
    def product(self, value):
        self._.product = value._

    @property
    def source_package(self):
        return SourcePackageAdapter(self._.distribution_package.source_package)

    @property
    def binary_packages(self):
        for x in self._.binary_packages:
            yield ProductBinaryPackageAdapter(x)

    def issues(self, cve=None):
        filter_by = {'package': self._}
        if cve:
            filter_by['issue'] = cve._
        for x in self.db_api.query(ProductPackageIssue,
                                   ProductPackageIssueAdapter,
                                   filter_by=filter_by):
            yield x

    def add_cve(self, cve, affected=True, resolved=False):
        obj = ProductPackageIssueAdapter.init(
            package=self._, issue=cve._)
        obj.set('affected', affected)
        obj.set('resolved', resolved)
        return obj

    def add_binary_package(self, name):
        obj = ProductBinaryPackageAdapter.init(
            product_package=self._, name=name)
        return obj

    def __str__(self):
        fields = []
        fields.append('{: <36}'.format(self.id))
        fields.append('{: <40}'.format(
            '{}-{}'.format(self.name, self.version)))
        fields.append('{: <15}'.format(str(self.product)))
        return ' | '.join(fields)

    @classmethod
    def update(cls, data={}):
        """
        :param data:
        :return:

        data = {
            "id": "",
            "source_package": "",
            "source_package_id": "",
            "spec_project": "",
            "source_project": "",
            "upstream_version": "",
            "package_origin": "",
            "distribution": {
                "alias": "",
                "name": "",
                "version": "",
                "arch": "",
            },
            "distribution_id": "",
            "product": {
                "name": "",
                "version": "",
            },
            "version": {
                "full_version": "",
            },
            "cves": [],
            "binary_packages": [],
        }
        """

        if 'source_package_id' in data:
            src_pkg = SourcePackageAdapter.init(
                id=data['source_package_id'])
        elif 'source_package' in data:
            prj = SourceProjectAdapter.init(
                name=data['source_package'])
            if 'upstream_version' in data:
                src_pkg = SourcePackageAdapter.init(
                    project=prj,
                    version=data['upstream_version']
                )
            else:
                src_pkg = None
        else:
            src_pkg = None

        version = DebianVersion(data['version']['full_version'])
        if 'distribution_package_id' in data:
            dist_pkg = DistributionPackageAdapter(
                id=data['distribution_package_id'])
            src_pkg = dist_pkg.source_package
        else:
            if 'distribution_id' in data:
                dist = DistributionAdapter(id=data['distribution_id'])
            elif 'distribution' in data:
                dist = DistributionAdapter.load_by_alias(
                    alias=data['distribution']['alias'],
                )
            else:
                dist = None

            if dist:
                dist_pkg = DistributionPackageAdapter.init(
                    distribution=dist,
                    source_package=src_pkg,
                    version=version.version,
                )
            else:
                dist_pkg = None

        if 'product_id' in data:
            product = ProductAdapter(id=data['product_id'])
        elif 'product' in data:
            product = ProductAdapter.init(
                name=data['product']['name'],
                version=data['product']['version']
            )
        else:
            product = None

        if 'id' in data:
            product_pkg = ProductPackageAdapter(id=data['id'])
            product_pkg.product = product
            product_pkg.distribution_package = dist_pkg
            product_pkg.version = version
        else:
            product_pkg = ProductPackageAdapter.init(
                product=product,
                distribution_package=dist_pkg,
                version=version.full_version,
            )

        if 'package_origin' in data:
            src_pkg.set_property(name='origin',
                                 value=data['package_origin'])

        if 'spec_project' in data:
            product_pkg.set_property(name='spec_project',
                              value=data['spec_project'])

        if 'source_project' in data:
            product_pkg.set_property(name='source_project',
                              value=data['source_project'])

        for name in data.get('cves', []):
            cve = CVEAdapter.init(name=name)
            src_pkg.add_cve(cve)
            dist_pkg.add_cve(cve, resolved=True)
            product_pkg.add_cve(cve, resolved=True)

        for item in data.get('binary_packages'):
            product_pkg.add_binary_package(item['name'])

        product_pkg.commit()

    def show(self, formatter=None):
        fields = (
            (('id',), 'ID'),
            (('distribution_package', '__str__'), 'Distribution Package'),
            (('distribution_package', 'source_package', '__str__'),
            'Source Package'),
            (('distribution_package', 'source_package', 'project', 'name'),
            'Name'),
            (('version',), 'Version'),
            (('distribution','__str__'), 'Distribution'),
            (('product', '__str__'), 'Product'),
        )
        cols, data, raw = super().show(fields=fields, formatter=formatter)

        if formatter == 'TableFormatter':
            for x in raw.get('issues', []):
                cols.append('CVE')
                data.append(x['__str__'])

            # for x in raw.get('binary_packages', []):
            #     cols.append('Package')
            #     data.append(x['name'])

        return cols, data, raw

    def export(self):
        data = super().export()

        data['binary_packages'] = [
            x.dict() for x in self.binary_packages
        ]

        data['issues'] = [
            x.dict() for x in self.issues()
        ]

        return data

    def dict(self, append={}):
        data = {
            'distribution': self.distribution.dict(),
            'distribution_package': self.distribution_package.dict(),
            'product': self.product.dict(),
            'version': self.version,
        }
        super().dict(data=data, append=append)
        return data


class ProductPackageIssueAdapter(GenericAdapter):
    @property
    def package(self):
        return ProductPackageAdapter(self._.package)

    @property
    def product(self):
        return ProductAdapter(self._.package.product)

    @property
    def issue(self):
        return CVEAdapter(self._.issue)

    @property
    def status(self):
        return self._.status or '<empty>'

    @status.setter
    def status(self, value):
        self._.status = value

    def __str__(self):
        fields = []
        fields.append('{: <15}'.format(str(self._.issue.name)))
        fields.append('{: <20}'.format(str(self.package)))
        fields.append('{}'.format('A' if self.affected else 'N/A'))
        fields.append('{}'.format('R' if self.resolved else 'N/R'))
        return ' | '.join(fields)

    def dict(self, append={}):
        # issue = CVEAdapter(self._.issue)
        data = {
            'issue': self.issue.dict(),
            'package': self.package.dict(),
            'affected': self.affected,
            'resolved': self.resolved,
            'status': self.status,
        }
        super().dict(data=data, append=append)
        return data


class SourceProjectAdapter(GenericAdapter):
    @property
    def packages(self):
        sp = None
        for sp in self.source_packages:
            dp = None
            for dp in sp.distribution_packages:
                pp = None
                for pp in dp.product_packages:
                    yield sp, dp, pp
                else:
                    if pp is None:
                        yield sp, dp, pp
            else:
                if dp is None:
                    yield sp, dp, pp
        else:
            if sp is None:
                yield sp, dp, pp

    @property
    def source_packages(self):
        for x in self._.source_packages:
            yield SourcePackageAdapter(x)

    @property
    def distribution_packages(self):
        for x in self.source_packages:
            for y in x.distribution_packages:
                yield y

    @property
    def product_packages(self):
        for x in self.distribution_packages:
            for y in x.product_packages:
                yield y

    def show(self, formatter=None):
        fields = ((('id',), 'ID'), (('name',), 'Name'), )
        cols, data, raw = super().show(fields=fields, formatter=formatter)

        if formatter == 'TableFormatter':
            for x in raw.get('source_packages', []):
                cols.append('Source Package')
                data.append(x['__str__'])

            for x in raw.get('distribution_packages', []):
                cols.append('Distribution Package')
                data.append(x['__str__'])

            for x in raw.get('product_packages', []):
                cols.append('Product Package')
                data.append(x['__str__'])

        return cols, data, raw

    def export(self):
        data = super().export()

        sps = set()
        dps = set()
        pps = set()
        for sp, dp, pp in self.packages:
            sps.add(sp)
            dps.add(dp)
            pps.add(pp)

        data['source_packages'] = [x.dict() for x in sps if x is not None]
        data['distribution_packages'] = [x.dict() for x in dps if x is not None]
        data['product_packages'] = [x.dict() for x in pps if x is not None]

        return data

    def dict(self, append={}):
        data = {
            'name': self.name,
            'description': self.description,
        }
        super().dict(data=data, append=append)
        return data


class SourcePackageAdapter(GenericAdapter):
    def issues(self, cve):
        for x in self.db_api.query(SourcePackageIssue,
                                   SourcePackageIssueAdapter,
                                   package=self._,
                                   issue=cve._):
            yield x

    @property
    def cves(self):
        for x in self._.issues:
            yield SourcePackageIssueAdapter(x)

    @property
    def advisories(self):
        for x in self._.advisories:
            yield AdvisoryAdapter(x)

    @property
    def distributions(self):
        for x in self._.distribution_packages:
            yield DistributionAdapter(x.distribution), x.version

    @property
    def distribution_packages(self):
        for x in self._.distribution_packages:
            yield DistributionPackageAdapter(x)

    @property
    def product_packages(self):
        for x in self.distribution_packages:
            for y in x.product_packages:
                yield ProductPackageAdapter(y)

    @property
    def packages(self):
        dp = None
        for dp in self.distribution_packages:
            pp = None
            for pp in dp.product_packages:
                yield self, dp, pp
            else:
                if pp is None:
                    yield self, dp, pp
        else:
            if dp is None:
                yield self, dp, pp

    @property
    def name(self):
        return self._.project.name

    @property
    def project(self):
        return SourceProjectAdapter(self._.project)

    def add_cve(self, cve, affected=True, resolved=False):
        obj = SourcePackageIssueAdapter.init(
            package=self._, issue=cve._)
        obj.set('affected', affected)
        obj.set('resolved', resolved)
        return obj

    def __str__(self):
        fields = []
        fields.append('{: <36}'.format(self.id))
        fields.append('{} {}'.format(self.name, self.version))
        return ' | '.join(fields)

    def show(self, formatter=None):
        fields = ((('id',), 'ID'), (('project', 'name',), 'Name'),
                  (('version',), 'Version'), )
        cols, data, raw = super().show(fields=fields, formatter=formatter)

        if formatter == 'TableFormatter':
            for x in raw.get('advisories', []):
                cols.append('Advisory')
                data.append(x['name'])

            for x in raw.get('cves', []):
                cols.append('CVE')
                data.append(x['issue']['name'])

            for x in raw.get('distribution_packages', []):
                cols.append('Distribution Package')
                data.append(x['__str__'])

            for x in raw.get('product_packages', []):
                cols.append('Product Package')
                data.append(x['__str__'])

        return cols, data, raw

    def export(self):
        data = super().export()

        data['advisories'] = [x.dict() for x in self.advisories]
        data['cves'] = [x.dict() for x in self.cves]
        data['project'] = self.project.dict()

        data['distribution_packages'] = []
        data['product_packages'] = []

        for x in self.distribution_packages:
            data['distribution_packages'].append(x.dict())
            for y in x.product_packages:
                data['product_packages'].append(y.dict())

        return data

    def dict(self, append={}):
        data = {
            'version': self.version,
            'project': self.project.dict(),
        }
        super().dict(data=data, append=append)
        return data


class SourcePackageIssueAdapter(GenericAdapter):
    @property
    def package(self):
        return SourcePackageAdapter(self._.package)

    @property
    def status(self):
        return self._.status or '<empty>'

    @status.setter
    def status(self, value):
        self._.status = value

    def __str__(self):
        fields = []
        fields.append('{: <15}'.format(str(self._.issue.name)))
        fields.append('{: <40}'.format(str(self.package)))
        fields.append('{}'.format('A' if self.affected else 'N/A'))
        fields.append('{}'.format('R' if self.resolved else 'N/R'))
        return ' | '.join(fields)

    def dict(self, append={}):
        issue = CVEAdapter(self._.issue)
        data = {
            'issue': issue.dict(),
            'package': self.package.dict(),
            'affected': self.affected,
            'resolved': self.resolved,
            'status': self.status,
        }
        super().dict(data=data, append=append)
        return data
