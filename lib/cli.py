
import json
import logging

from lib.db.api import DbApi

from cliff.command import Command
from cliff.lister import Lister
from cliff.show import ShowOne

from lib.objects import SecurityAdvisory
from lib.adapter import AdvisoryAdapter
from lib.adapter import CVEAdapter
from lib.adapter import DistributionAdapter
from lib.adapter import PackageAdapter

from lib.db.models import CVE
from lib.db.models import CVEProperty
from lib.db.models import SourcePackage
from lib.db.models import SourcePackageProperty
from lib.db.models import SourcePackageDistribution
from lib.db.models import SourcePackageDistributionProperty
from lib.db.models import Distribution
from lib.db.models import DistributionProperty
from lib.db.models import Product
from lib.db.models import ProductProperty
from lib.db.models import ProductDistributionPackage
from lib.db.models import ProductDistributionPackageProperty


GENERIC_DIST = {
    'trusty': {
        'name': 'Ubuntu',
        'version': '14.04',
    },
    'xenial': {
        'name': 'Ubuntu',
        'version': '16.04',
    },
    'el6': {
        'name': 'RedHat',
        'version': '6',
    },
    'el7': {
        'name': 'RedHat',
        'version': '7',
    }
}


def map_parsed_args(parsed_args, args_map):
    d = {}
    for arg, key in args_map.items():
        value = getattr(parsed_args, arg, None)
        if value:
            d[key] = value
    return d


class CliImportAdvisory(Command):
    log = logging.getLogger(__name__)

    def get_parser(self, prog_name):
        parser = super(CliImportAdvisory, self).get_parser(prog_name)
        parser.add_argument('filename')
        return parser

    def take_action(self, parsed_args):
        filename = parsed_args.filename
        self.log.info("Importing advisory data from '{}'".format(filename))

        count = 0
        db_api = DbApi()
        with open(filename) as f:
            adv_list = json.load(f)

            for adv_name, adv_data in adv_list.items():
                count += 1

                adv = SecurityAdvisory(adv_name)
                adv.advisory.url = adv_data.get('url', '')

                for cve_name, cve_data in adv_data.get('cves', {}).items():
                    cve = adv.add_cve(cve_name)
                    cve.url = cve_data['url']

                for pkg in adv_data.get('packages', []):
                    spkg = adv.add_source_package(
                        pkg['name'],
                        pkg['upstream_version']
                    )

                    dist_data = GENERIC_DIST.get(pkg['dist'])
                    dist = db_api.get(
                        Distribution,
                        name=dist_data['name'],
                        version=dist_data['version']
                    )

                    link = db_api.get(
                        SourcePackageDistribution,
                        source_package=spkg,
                        distribution=dist
                    )

                    db_api.add_property(
                        link,
                        name='full_version',
                        value=pkg['full_version']
                    )

                adv.save()

        self.log.info('Import done. Imported {} advisory object(s).'
                      .format(count))


class CliImportPackage(Command):
    log = logging.getLogger(__name__)

    def get_parser(self, prog_name):
        parser = super(CliImportPackage, self).get_parser(prog_name)
        parser.add_argument('filename')
        return parser

    def take_action(self, parsed_args):
        filename = parsed_args.filename
        self.log.info("Importing packages data from '{}'".format(filename))

        count = 0
        db_api = DbApi()
        with open(filename) as f:
            pkgs_json = json.load(f)
            for data in pkgs_json:
                count += 1

                pkg = db_api.get(
                    SourcePackage,
                    name=data['source_package'],
                    version=data['upstream_version']
                )

                dist = db_api.get(
                    Distribution,
                    name=data['distribution']['name'],
                    version=data['distribution']['version'],
                    arch=data['distribution']['arch']
                )

                prod = db_api.get(
                    Product,
                    name=data['product']['name'],
                    version=data['product']['version']
                )

                # Need this before adding to association table below
                db_api.session.commit()

                link = db_api.get(
                    ProductDistributionPackage,
                    product=prod,
                    distribution=dist,
                    source_package=pkg
                )

                for name in ['epoch', 'version', 'revision', 'raw']:
                    value = data['version'].get(name, None)
                    if value:
                        db_api.add_property(link, name, value, unique=True)

                for key in ['spec_project', 'source_project']:
                    value = data.get(key, None)
                    if value:
                        db_api.add_property(link, key, value)

                db_api.session.commit()


        self.log.info('Import done. Imported {} package object(s).'
                      .format(count))


class CliListCve(Lister):
    log = logging.getLogger(__name__)

    def take_action(self, parsed_args):
        db_api = DbApi()
        objs = db_api.session.query(CVE).all()
        return (('ID', 'Name', 'Subject'),
                ((obj.id, obj.name, obj.subject) for obj in objs)
                )


class CliListPackage(Lister):
    log = logging.getLogger(__name__)

    def take_action(self, parsed_args):
        db_api = DbApi()
        objs = db_api.session.query(SourcePackage).all()
        return (('ID', 'Name', 'Version'),
                ((obj.id, obj.name, obj.version) for obj in objs)
                )


class CliListProduct(Lister):
    log = logging.getLogger(__name__)

    def take_action(self, parsed_args):
        db_api = DbApi()
        objs = db_api.session.query(Product).all()
        return (('ID', 'Name', 'Version', 'Vendor'),
                ((obj.id, obj.name, obj.version, obj.vendor) for obj in objs)
                )


class CliListDistribution(Lister):
    log = logging.getLogger(__name__)

    def take_action(self, parsed_args):
        db_api = DbApi()
        objs = db_api.session.query(Distribution).all()
        return (('ID', 'Name', 'Version', 'Arch'),
                ((obj.id, obj.name, obj.version, obj.arch) for obj in objs)
                )


class CliShowCve(ShowOne):
    log = logging.getLogger(__name__)

    def get_parser(self, prog_name):
        parser = super(CliShowCve, self).get_parser(prog_name)
        parser.add_argument('--id')
        parser.add_argument('--name')
        return parser

    def take_action(self, parsed_args):
        args_map = {
            'id': 'id',
            'name': 'name',
            'base_version': 'version',
        }
        _kwargs = map_parsed_args(parsed_args, args_map)
        cve = CVEAdapter(**_kwargs)

        cols = ['Name', 'Subject', ]
        data = [cve.name, cve.subject, ]
        for prop in cve.properties:
            cols.append('Property:{}'.format(prop.name))
            data.append(prop.value)

        advisories = [x.name for x in cve.advisories]
        advisories.sort()

        pkgs = ['{}-{}'.format(x.name, x.version)
                for x in cve.source_packages]
        pkgs.sort()

        formatter = self.formatter.__class__.__name__
        if formatter == 'TableFormatter':
            for item in advisories:
                cols.append('Advisory')
                data.append(item)

            for item in pkgs:
                cols.append('Package affected')
                data.append(item)
        else:
            cols.append('Advisories')
            data.append(advisories)

            cols.append('Packages')
            data.append(pkgs)

        return (cols, data)


class CliShowPackage(ShowOne):
    log = logging.getLogger(__name__)

    def get_parser(self, prog_name):
        parser = super(CliShowPackage, self).get_parser(prog_name)
        parser.add_argument('--id')
        parser.add_argument('--name')
        parser.add_argument('--base-version')
        return parser

    def take_action(self, parsed_args):
        args_map = {
            'id': 'id',
            'name': 'name',
            'base_version': 'version',
        }
        _kwargs = map_parsed_args(parsed_args, args_map)
        pkg = PackageAdapter(**_kwargs)

        cols = ['ID', 'Name', 'Version', ]
        data = [pkg.id, pkg.name, pkg.version, ]

        for prop in pkg.properties:
            cols.append('Property:{}'.format(prop.name))
            data.append(prop.value)

        advisories = [x.name for x in pkg.advisories]
        advisories.sort()

        cves = [x.name for x in pkg.cves]
        cves.sort()

        distributions = ['{} {} {}'.format(x.name, x.version, x.arch)
                         for x in pkg.distributions]
        distributions.sort()

        formatter = self.formatter.__class__.__name__
        if formatter == 'TableFormatter':
            for item in advisories:
                cols.append('Advisory')
                data.append(item)

            for item in cves:
                cols.append('CVE')
                data.append(item)

            for item in distributions:
                cols.append('Distribution')
                data.append(item)
        else:
            cols.append('Advisories')
            data.append(advisories)

            cols.append('CVE')
            data.append(cves)

            cols.append('Distributions')
            data.append(distributions)

        return (cols, data)


class CliShowDistribution(ShowOne):
    log = logging.getLogger(__name__)

    def get_parser(self, prog_name):
        parser = super(CliShowDistribution, self).get_parser(prog_name)
        parser.add_argument('--id')
        parser.add_argument('--name')
        parser.add_argument('--dist-version')
        parser.add_argument('--arch', default='x86_64')
        return parser

    def take_action(self, parsed_args):
        args_map = {
            'id': 'id',
            'name': 'name',
            'dist_version': 'version',
            'arch': 'arch',
        }
        _kwargs = map_parsed_args(parsed_args, args_map)
        dist = DistributionAdapter(**_kwargs)

        cols = ['ID', 'Name', 'Version', 'Arch']
        data = [dist.id, dist.name, dist.version, dist.arch]

        for pkg in dist.source_packages:
            cols.append('Package')
            data.append('{} {}'.format(pkg.name, pkg.version))

        return (cols, data)


class CliShowAdvisory(ShowOne):
    log = logging.getLogger(__name__)

    def get_parser(self, prog_name):
        parser = super(CliShowAdvisory, self).get_parser(prog_name)
        parser.add_argument('--id')
        parser.add_argument('--name')
        return parser

    def take_action(self, parsed_args):
        args_map = {
            'id': 'id',
            'name': 'name',
        }
        _kwargs = map_parsed_args(parsed_args, args_map)
        obj = AdvisoryAdapter(**_kwargs)

        cols = ['ID', 'Name']
        data = [obj.id, obj.name]

        for item in obj.source_packages:
            cols.append('Package')
            data.append('{} {}'.format(item.name, item.version))

        for item in obj.cves:
            cols.append('CVE')
            data.append(item.name)

        return (cols, data)
