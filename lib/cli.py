
import json
import logging

from lib.db.api import DBAPI

from cliff.command import Command
from cliff.lister import Lister
from cliff.show import ShowOne

from lib.adapter import AdvisoryAdapter
from lib.adapter import CVEAdapter
from lib.adapter import DistributionAdapter
from lib.adapter import PackageAdapter

from lib.db.models import Advisory
from lib.db.models import AdvisoryProperty
from lib.db.models import CVE
from lib.db.models import CVEProperty
from lib.db.models import SourcePackage
from lib.db.models import SourcePackageProperty
from lib.db.models import SourcePackageDistribution
from lib.db.models import SourcePackageDistributionProperty
from lib.db.models import Distribution
from lib.db.models import DistributionProperty
from lib.db.models import Product
from lib.db.models import ProductProperty
from lib.db.models import ProductDistributionPackage
from lib.db.models import ProductDistributionPackageProperty


GENERIC_DIST = {
    'trusty': {
        'name': 'Ubuntu',
        'version': '14.04',
    },
    'xenial': {
        'name': 'Ubuntu',
        'version': '16.04',
    },
    'el6': {
        'name': 'RedHat',
        'version': '6',
    },
    'el7': {
        'name': 'RedHat',
        'version': '7',
    }
}


def map_parsed_args(parsed_args, args_map):
    d = {}
    for arg, key in args_map.items():
        value = getattr(parsed_args, arg, None)
        if value:
            d[key] = value
    return d


class CliImportAdvisory(Command):
    log = logging.getLogger(__name__)

    def get_parser(self, prog_name):
        parser = super(CliImportAdvisory, self).get_parser(prog_name)
        parser.add_argument('filename')
        return parser

    def take_action(self, parsed_args):
        filename = parsed_args.filename
        self.log.info("Importing advisory data from '{}'".format(filename))

        count = 0
        with open(filename) as f:
            adv_list = json.load(f)

            for adv_name, adv_data in adv_list.items():
                count += 1

                adv = AdvisoryAdapter()
                adv.load_create(name=adv_name)
                adv.set('url', adv_data.get('url', ''))
                adv.set('subject', adv_data.get('subject', ''))

                for cve_name, cve_data in adv_data.get('cves', {}).items():
                    cve = adv.add_cve(cve_name)
                    cve.set('subject', cve_data.get('subject', ''))
                    url = cve_data.get('url', None)
                    if url:
                        cve.add_property(
                            name='URL',
                            value=url
                        )

                    for url in cve_data.get('references', []):
                        cve.add_property(name='Reference', value=url)

                for pkg in adv_data.get('packages', []):
                    spkg = adv.add_source_package(
                        name=pkg['name'],
                        version=pkg['upstream_version']
                    )

                    dist_data = GENERIC_DIST.get(pkg['dist'])
                    dist = DistributionAdapter()
                    dist.load_create(
                        name=dist_data['name'],
                        version=dist_data['version']
                    )
                    dist.add_package(
                        source_package=spkg,
                        version=pkg['full_version']
                    )

                adv.commit()

        self.log.info('Import done. Imported {} advisory object(s).'
                      .format(count))


class CliImportPackage(Command):
    log = logging.getLogger(__name__)

    def get_parser(self, prog_name):
        parser = super(CliImportPackage, self).get_parser(prog_name)
        parser.add_argument('filename')
        return parser

    def take_action(self, parsed_args):
        filename = parsed_args.filename
        self.log.info("Importing packages data from '{}'".format(filename))

        count = 0
        db_api = DBAPI()
        with open(filename) as f:
            pkgs_json = json.load(f)
            for data in pkgs_json:
                count += 1

                pkg = db_api.get(
                    SourcePackage,
                    name=data['source_package'],
                    version=data['upstream_version']
                )

                dist = db_api.get(
                    Distribution,
                    name=data['distribution']['name'],
                    version=data['distribution']['version'],
                    arch=data['distribution']['arch']
                )

                prod = db_api.get(
                    Product,
                    name=data['product']['name'],
                    version=data['product']['version']
                )

                # Need this before adding to association table below
                db_api.session.commit()

                link = db_api.get(
                    ProductDistributionPackage,
                    product=prod,
                    distribution=dist,
                    source_package=pkg
                )

                for name in ['epoch', 'version', 'revision', 'raw']:
                    value = data['version'].get(name, None)
                    if value:
                        db_api.add_property(link, name, value, unique=True)

                for key in ['spec_project', 'source_project']:
                    value = data.get(key, None)
                    if value:
                        db_api.add_property(link, key, value)

                db_api.session.commit()


        self.log.info('Import done. Imported {} package object(s).'
                      .format(count))


class CliListAdvisory(Lister):
    log = logging.getLogger(__name__)

    def take_action(self, parsed_args):
        db_api = DBAPI()
        objs = db_api.session.query(Advisory).all()
        cols = ('ID', 'Name', 'Subject', 'URL')
        data = [(obj.id, obj.name, obj.subject, obj.url)
                for obj in objs]
        data.sort(key=lambda x: x[1])
        return cols, data


class CliListCve(Lister):
    log = logging.getLogger(__name__)

    def take_action(self, parsed_args):
        db_api = DBAPI()
        objs = db_api.session.query(CVE).all()
        cols = ('ID', 'Name', 'Subject')
        data = [(obj.id, obj.name, obj.subject) for obj in objs]
        data.sort(key=lambda x: x[1])
        return cols, data


class CliListPackage(Lister):
    log = logging.getLogger(__name__)

    def take_action(self, parsed_args):
        db_api = DBAPI()
        objs = db_api.session.query(SourcePackage).all()
        cols = ('ID', 'Name', 'Version')
        data = [(obj.id, obj.name, obj.version) for obj in objs]
        data.sort(key=lambda x: ''.join((x[1], x[2])))
        return cols, data


class CliListProduct(Lister):
    log = logging.getLogger(__name__)

    def take_action(self, parsed_args):
        db_api = DBAPI()
        objs = db_api.session.query(Product).all()
        cols = ('ID', 'Name', 'Version', 'Vendor')
        data = [(obj.id, obj.name, obj.version, obj.vendor) for obj in objs]
        data.sort(key=lambda x: ''.join((x[1], x[2])))
        return cols, data


class CliListDistribution(Lister):
    log = logging.getLogger(__name__)

    def take_action(self, parsed_args):
        db_api = DBAPI()
        objs = db_api.session.query(Distribution).all()
        cols = ('ID', 'Name', 'Version', 'Arch')
        data = [(obj.id, obj.name, obj.version, obj.arch) for obj in objs]
        data.sort(key=lambda x: x[1])
        return cols, data


class CliShowCve(ShowOne):
    log = logging.getLogger(__name__)

    def get_parser(self, prog_name):
        parser = super(CliShowCve, self).get_parser(prog_name)
        parser.add_argument('--id')
        parser.add_argument('--name')
        return parser

    def take_action(self, parsed_args):
        args_map = {
            'id': 'id',
            'name': 'name',
            'base_version': 'version',
        }
        _kwargs = map_parsed_args(parsed_args, args_map)
        cve = CVEAdapter()
        cve.try_load(**_kwargs)

        cols = ['Name', 'Subject', ]
        data = [cve.name, cve.subject, ]

        advisories = [x.name for x in cve.advisories]
        advisories.sort()

        pkgs = ['{}-{}'.format(x.name, x.version)
                for x in cve.source_packages]
        pkgs.sort()

        formatter = self.formatter.__class__.__name__
        if formatter == 'TableFormatter':
            for item in advisories:
                cols.append('Advisory')
                data.append(item)

            for item in pkgs:
                cols.append('Affects')
                data.append(item)

            for prop in cve.properties:
                cols.append('Property:{}'.format(prop.name))
                data.append(prop.value)
        else:
            cols.append('Advisories')
            data.append(advisories)

            cols.append('Packages')
            data.append(pkgs)

        return cols, data


class CliShowPackage(ShowOne):
    log = logging.getLogger(__name__)

    def get_parser(self, prog_name):
        parser = super(CliShowPackage, self).get_parser(prog_name)
        parser.add_argument('--id')
        parser.add_argument('--name')
        parser.add_argument('--base-version')
        return parser

    def take_action(self, parsed_args):
        args_map = {
            'id': 'id',
            'name': 'name',
            'base_version': 'version',
        }
        _kwargs = map_parsed_args(parsed_args, args_map)
        pkg = PackageAdapter()
        pkg.try_load(**_kwargs)

        cols = ['ID', 'Name', 'Version', ]
        data = [pkg.id, pkg.name, pkg.version, ]

        for prop in pkg.properties:
            cols.append('Property:{}'.format(prop.name))
            data.append(prop.value)

        advisories = [(x.id, x.name) for x in pkg.advisories]
        advisories.sort(key=lambda x: x[1])

        cves = [(x.id, x.name) for x in pkg.cves]
        cves.sort(key=lambda x: x[1])

        distributions = [(obj.id, obj.name, obj.version, obj.arch, ver)
                         for obj, ver in pkg.distributions]
        distributions.sort(key=lambda x: x[1])

        formatter = self.formatter.__class__.__name__
        if formatter == 'TableFormatter':
            for item in advisories:
                cols.append('Advisory')
                data.append(item)

            for item in cves:
                cols.append('CVE')
                data.append(item)

            for item in distributions:
                cols.append('Distribution')
                data.append(item)
        else:
            cols.append('Advisories')
            data.append(advisories)

            cols.append('CVE')
            data.append(cves)

            cols.append('Distributions')
            data.append(distributions)

        return cols, data


class CliShowDistribution(ShowOne):
    log = logging.getLogger(__name__)

    def get_parser(self, prog_name):
        parser = super(CliShowDistribution, self).get_parser(prog_name)
        parser.add_argument('--id')
        parser.add_argument('--name')
        parser.add_argument('--dist-version')
        parser.add_argument('--arch', default='x86_64')
        return parser

    def take_action(self, parsed_args):
        args_map = {
            'id': 'id',
            'name': 'name',
            'dist_version': 'version',
            'arch': 'arch',
        }
        _kwargs = map_parsed_args(parsed_args, args_map)
        dist = DistributionAdapter()
        dist.try_load(**_kwargs)

        cols = ['ID', 'Name', 'Version', 'Arch']
        data = [dist.id, dist.name, dist.version, dist.arch]

        pkgs = []
        for pkg, ver in dist.source_packages:
            pkgs.append((pkg.id, pkg.name, pkg.version, ver))
        pkgs.sort(key=lambda x: ''.join((x[1], x[3])))

        for pkg in pkgs:
            cols.append('Package')
            data.append(pkg)

        return cols, data


class CliShowAdvisory(ShowOne):
    log = logging.getLogger(__name__)

    def get_parser(self, prog_name):
        parser = super(CliShowAdvisory, self).get_parser(prog_name)
        parser.add_argument('--id')
        parser.add_argument('--name')
        return parser

    def take_action(self, parsed_args):
        args_map = {
            'id': 'id',
            'name': 'name',
        }
        _kwargs = map_parsed_args(parsed_args, args_map)
        obj = AdvisoryAdapter()
        obj.try_load(**_kwargs)

        cols = ['ID', 'Name', 'Subject', 'URL']
        data = [obj.id, obj.name, obj.subject, obj.url]

        for item in obj.source_packages:
            cols.append('Package')
            data.append((item.id, item.name, item.version, ))

        for item in obj.cves:
            cols.append('CVE')
            data.append((item.id, item.name, ))

        for x in obj.properties:
            cols.append('Property:{}'.format(x.name))
            data.append(x.value)

        return cols, data
